#detection
$service = Get-Service -Name "Sysmon64" -ErrorAction SilentlyContinue

if (-not $service) {
    # Sysmon is not installed â€” exit with 0 (success)
    exit 0
}

try {
    $versionOutput = & "$env:SystemRoot\Sysmon64.exe" -v 2>&1
    if (-not $versionOutput) {
        $versionOutput = & "Sysmon64.exe" -v 2>&1
    }
} catch {
    Write-Error "Failed to run Sysmon64.exe to get version"
    exit 1
}

if ($versionOutput -match "v(\d+)\.(\d+)") {
    $major = [int]$matches[1]
    $minor = [int]$matches[2]

    if ($major -lt 15 -or ($major -eq 15 -and $minor -lt 14)) {
        exit 1
    } else {
        exit 0
    }
} else {
    Write-Error "Could not parse Sysmon version from output: $versionOutput"
    exit 1
}

#remediation
$dl = "https://download.sysinternals.com/files/Sysmon.zip"
$tmp = "$env:TEMP\sysmon"
$zip = "$tmp\Sysmon.zip"

Remove-Item -Recurse -Force $tmp -ErrorAction SilentlyContinue
New-Item -ItemType Directory -Path $tmp | Out-Null

Invoke-WebRequest -Uri $dl -OutFile $zip -UseBasicParsing

Expand-Archive -Path $zip -DestinationPath $tmp -Force

& "$tmp\Sysmon64.exe" -u
Start-Sleep -Seconds 3

& "$tmp\Sysmon64.exe" -accepteula -i
if ($LASTEXITCODE -ne 0) {
    exit 1
}

Remove-Item -Recurse -Force $tmp
exit 0
